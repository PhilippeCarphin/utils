#!/usr/bin/env python3

import sys
import re
import argparse

def get_args():
    p = argparse.ArgumentParser()
    p.add_argument("-f", "--field", type=int, help="Field number")
    p.add_argument("-a", "--also", type=str)
    p.add_argument("-d", "--delim", default=' ', type=str, help="Delimiters")
    return p.parse_args()

def parse_word_with_leading_whitespace(i, delims):
    letters = []
    while True:
        c = next(i)
        if c in ' ':
            letters.append(c)
        else:
            letters.append(c)
            break
    while True:
        try:
            c = next(i)
        except StopIteration:
            return ''.join(letters)
        if c in delims:
            return ''.join(letters)
        else:
            letters.append(c)

def split_preserve_whitespace(s, delims):
    words = []
    i = iter(s)
    try:
        while True:
            words.append(parse_word_with_leading_whitespace(i, delims))
    except StopIteration:
        return words

ansi = re.compile(r'\x1b\[[0-7;]*m')

def recolor(token, color):
    token = ansi.sub('', token)
    return f"\033[38;5;{color}m{token}\033[0m"

def main():
    color = 100
    token_colors = {}
    lineno = 0
    args = get_args()
    for l in sys.stdin:
        lineno += 1
        words = split_preserve_whitespace(l.strip(), args.delim)
        if len(words) <= args.field:
            print(f"({' '.join(sys.argv)}: line #{lineno} only has {len(words)} fields", file=sys.stderr)
            continue
        token = words[args.field]
        if token in token_colors:
            color = token_colors[token]
        else:
            color += 3
            if color > 231:
                color = 20
            token_colors[token] = color

        if args.also:
            if args.also.endswith('+'):
                n = int(args.also[:-1])
                words = words[:n] + [recolor(args.delim.join(words[n:]), color)]
        else:
            words[args.field] = recolor(token, color)

        print(args.delim[0].join(words))

if __name__ == "__main__":
    sys.exit(main())
