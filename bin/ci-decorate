#!/usr/bin/env bash

main(){
    while read -r line; do
        if [[ "${line}" == '#%ci-decorate-begin-exclude'* ]] ; then
            excluding=1
            printf "\n"
            while read -r line ; do
                if [[ "${line}" == '#%ci-decorate-end-exclude'* ]] ; then
                    excluding=0
                    printf "\n"
                    break
                fi
                echo "${line}"
            done
        elif [[ "${line}" == '#'* ]] ; then
            echo "printf \"\033[34m%s\033[0m\n\" \"$(escape "${line}")\" ; "
        elif [[ "${line}" == "" ]] ; then
            echo "printf '\n'"
        else
            echo -n "printf \"\033[1;32m\$ %s\033[0m\n\" \"$(escape "${line}")\" ; "
            printf "%s;\n" "${line}"
        fi
    done
    if (( ${excluding:-0} == 1 )) ; then
        printf "ci-decorate: \033[1;31mERROR\033[0m: %s\n" 'unterminated #%ci-decorate-begin-exclude' >&2
        exit 1
    fi
}

escape(){
    line="$1"
    escaped=${line//\\/\\\\}
    escaped=${escaped//$/\\$}
    escaped=${escaped//'"'/\\'"'}
    echo "${escaped}"
}

main "$@"
